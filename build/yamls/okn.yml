# yaml template for OKN Agent DaemonSet
# Right config parameters and OKN Docker image must be specified.

# ConfigMap for okn.ini
apiVersion: v1
kind: ConfigMap
metadata:
  name: okn-config
  labels:
    version: v1
data:
  okn.conf: |
    # Configuration for OKN Agent
    agent:
      # Name of the OVS bridge.
      # ovsBridge: br-int


---
# nsx-node-agent DaemonSet
apiVersion: extensions/v1beta1
kind: DaemonSet
metadata:
  name: okn-agent
  labels:
    tier: okn
    component: okn-agent
    version: v1
spec:
  updateStrategy:
    type: RollingUpdate
  template:
    metadata:
      labels:
        tier: okn
        component: okn-agent
        version: v1
    spec:
      hostNetwork: true
      initContainers:
        - name: install-cni
          image: okn-ubuntu
          imagePullPolicy: IfNotPresent
          command: ["install_cni"]
          volumeMounts:
          - name: config-volume
            mountPath: /etc/okn/okn.conf
            subPath: okn.conf
            readOnly: true
          - name: host-cni-conf
            mountPath: /host/etc/cni/net.d
          - name: host-cni-bin
            mountPath: /host/opt/cni/bin
          - name: host-var-run-okn
            mountPath: /host/var/run/okn
      containers:
        - name: okn-agent
          image: okn-ubuntu
          imagePullPolicy: IfNotPresent
          command: ["start_okn_agent"]
          livenessProbe:
            exec:
              command:
                - /bin/sh
                - -c
                - check_pod_liveness agent
            initialDelaySeconds: 5
            timeoutSeconds: 5
            periodSeconds: 10
            failureThreshold: 5
          securityContext:
            capabilities:
              add:
                - NET_ADMIN
                - SYS_ADMIN
          volumeMounts:
          - name: config-volume
            mountPath: /etc/okn/okn.conf
            subPath: okn.conf
            readOnly: true
          - name: host-var-run-okn
            mountPath: /var/run/okn
        - name: okn-ovs
          image: okn-ubuntu
          imagePullPolicy: IfNotPresent
          command: ["start_ovs"]
          securityContext:
            capabilities:
              add:
                - SYS_NICE
          livenessProbe:
            exec:
              command:
                - /bin/sh
                - -c
                - timeout 5 check_pod_liveness ovs
            initialDelaySeconds: 5
            periodSeconds: 5
          volumeMounts:
          - name: config-volume
            mountPath: /etc/okn/okn.conf
            subPath: okn.conf
            readOnly: true
          # mount openvswitch dir
          - name: openvswitch
            mountPath: /var/run/openvswitch
      volumes:
        - name: config-volume
          configMap:
            name: okn-config
        - name: openvswitch
          hostPath:
            path: /var/run/openvswitch
        - name: host-cni-conf
          hostPath:
            path: /etc/cni/net.d
        - name: host-cni-bin
          hostPath:
            path: /opt/cni/bin
        - name: host-var-run-okn
          hostPath:
            path: /var/run/okn
